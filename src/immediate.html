<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>LINE自動配信ツール</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="form.css">
    <script src="maketable.min.js"></script>
  </head>
  <body>
    <h2>即時LINE配信</h2>
    <div class="cp_ipselect cp_sl01">
      <select id="channel-select" required>
        <option value="">--チャネル選択--</option>
      </select>
    </div>
    <div class="cp_ipselect cp_sl01">
      <select id="plan-select">
        <option value="">--プラン選択--</option>
      </select>
    </div>
    <div id="csvfile" class="buttonarea">
      <button class="button-g" value="reader" onclick="readCSV()">顧客番号CSV読込</button>
      <div id="csvfilepath"></div>
    </div>
    <div id="reservation" class="buttonarea">
      <button class="button-g" value="broadcast" onclick="broadcast()">今すぐLINE配信</button>
    </div>
    <div class="buttonarea">
      <button class="button-g button-4" value="back" onclick="history.back()">戻る</button>
    </div>
    
    <script>
      // チャネル
      const channelDom = document.getElementById('channel-select');
      // プラン名
      const plannameDom = document.getElementById('plan-select');
      // CSVファイル
      const csvfileDom = document.getElementById('csvfilepath');

      // プラン登録完了
      window.api.on("broadcast_register_finish", _ => {
        // メッセージオプション
        const messageOption = {
          title: "登録完了",
          message: "登録が完了しました",
          type: "info",
        }
        // ポップアップ表示
        window.api.send("showmessage", messageOption);
        // フォームクリア
        csvfileDom.innerHTML = "";
        channelDom.options[0].selected = true;
        plannameDom.options[0].selected = true;
      });

      // エラー発生
      window.api.on("error", arg => {
        // メッセージオプション
        const messageOption = {
          title: "エラー",
          message: arg,
          type: "fatal",
        }
        // ポップアップ表示
        window.api.send("showmessage", messageOption);
      });

      // チャネル
      window.api.on("channelMasterllist", arg => {
        try {
          // チャネル自動生成
          arg.forEach((obj, idx) => {
            // オプションタグ生成
            const option = document.createElement('option');
            // 値代入
            option.value = String(obj.id);
            option.textContent  = `${obj.id}: ${obj.channelname}`;
            // セレクトに追加
            channelDom.appendChild(option);
          });

        } catch(e) {
          // エラー処理
          console.log(e);
        }
      });

      // プラン
      window.api.on("planMasterllist", arg => {
        try {
          // プラン自動生成
          arg.forEach((obj, idx) => {
            // オプションタグ生成
            const option = document.createElement('option');
            // 値代入
            option.value = String(obj.id);
            option.textContent  = `${obj.id}: ${obj.planname}`;
            // セレクトに追加
            plannameDom.appendChild(option)
          });

        } catch(e) {
          // エラー処理
          console.log(e);
        }
      });

      // ユーザ
      window.api.on("usersCsvlist", arg => {
        try {
          // ユーザ一覧
          const userArray = arg.record.flat();
          // JSON文字列変換
          const serializedArray = JSON.stringify(userArray);
          // localStorage保存
          localStorage.setItem('userArray', serializedArray);
          // ファイルパス表示
          csvfileDom.innerHTML = arg.filename;
          
        } catch(e) {
          // エラー処理
          console.log(e);
        }
      });

      // ページ遷移
      const transfer = channel => {
        try {
          // 配信ページ遷移
          window.api.send("page", channel);

        } catch(e) {
          // エラー処理
          console.log(e);
        }
      }

      // CSVモード
      const readCSV = () => {
        try {
          // CSVモード
          window.api.send("csv");

        } catch(e) {
          // エラー処理
          window.api.send("error", e);
        }
      }

      // 即時配信モード
      const broadcast = () => {
        try {
          // ユーザ一覧
          const serializedArray = localStorage.getItem('userArray');
          // エラーフラグ
          let errorflg;
          // エラーメッセージ
          let errorArray = [];
          // エラーメッセージ
          let userArray = [];
          // 選択チャンネル
          const channel = channelDom.value;
          // 選択プラン
          const plan = plannameDom.value;
          
          // ユーザなし
          if (!serializedArray) {
            errorArray.push("顧客CSVを選択してください");
            errorflg = true;

          } else {
            // JSON文字列変換
            userArray = JSON.parse(serializedArray);
          }
          
          /* バリデーション */
          // チャネル
          if (channelDom.options[0].selected) {
            errorArray.push("チャネルを選択してください");
            errorflg = true;
          }
          // プラン
          if (plannameDom.options[0].selected) {
            errorArray.push("プランを選択してください");
            errorflg = true;
          }

          // エラーなし
          if (!errorflg) {
            // 送付内容
            const broadcastObj = {
              channel: channel, // 選択チャンネル
              plan: plan, // 選択プラン
              users: userArray, // ユーザ一覧
            }
            // 配信モード
            window.api.send("broadcast", broadcastObj);

          } else {
            // メッセージオプション
            const messageOption = {
              title: "エラー",
              message: errorArray.join("|"),
              type: "error",
            }
            // エラー表示
            window.api.send("showmessage", messageOption);
          }
          
        } catch(e) {
          // エラー処理
          window.api.send("error", e);
        }
      }
    </script>
  </body>
</html>
