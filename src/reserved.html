<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>LINE自動配信ツール</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="form.css">
    <script src="maketable.min.js"></script>
  </head>
  <body>
    <h2>予約LINE配信</h2>
    <div class="cp_ipselect cp_sl01">
      <select id="channel-select" required>
        <option value="">--チャネル選択--</option>
      </select>
    </div>
    <div class="cp_ipselect cp_sl01">
      <select id="plan-select">
        <option value="">--配信タイプ選択--</option>
      </select>
    </div>
    <div class="dialogs">
      <h3>配信日選択</h3>
      <div class="date01">
        <label class="modal datelabel" for="date">
          <input type="date" id="date" name="配信日" value="">
        </label>
      </div>
      <h3>配信時刻選択</h3>
      <div class="time01">
        <label class="modal timelabel" for="time">
          <input type="time" id="time" name="配信時刻" value="00:00">
        </label>
      </div>
    </div>
    <div id="csvfile" class="buttonarea">
      <button class="button-g" value="reader" onclick="readCSV()">顧客番号CSV読込</button>
      <div id="csvfilepath"></div>
    </div>
    <div id="reservation" class="buttonarea">
      <button id="" class="button-g" value="reserve" onclick="reserve()">LINE配信予約</button>
    </div>
    <div class="buttonarea">
      <button class="button-g button-4" value="back" onclick="history.back()">戻る</button>
    </div>
    <script>
      // プラン名
      const plannameDom = document.getElementById('plan-select');
      // 選択チャンネル
      const channelDom = document.getElementById('channel-select');
      // 配信日
      const datelDom = document.getElementById('date');
      // 配信時刻
      const timelDom = document.getElementById('time');
      // CSVファイル
      const csvfileDom = document.getElementById('csvfilepath');

      // プラン登録完了
      window.api.on("broadcast_register_finish", _ => {
        // メッセージオプション
        const messageOption = {
          title: "登録完了",
          message: "登録が完了しました",
          type: "info",
        }
        // ポップアップ表示
        window.api.send("showmessage", messageOption);
        // フォームクリア
        datelDom.value = "";
        timelDom.value = "00:00";
        csvfileDom.innerHTML = "";
        channelDom.options[0].selected = true;
        plannameDom.options[0].selected = true;
      });

      // エラー発生
      window.api.on("error", arg => {
        // メッセージオプション
        const messageOption = {
          title: "エラー",
          message: arg,
          type: "fatal",
        }
        // ポップアップ表示
        window.api.send("showmessage", messageOption);
      });

      // チャンネル
      window.api.on("channelMasterllist", arg => {
        try {
          // プラン自動生成
          arg.forEach((obj, idx) => {
            // オプションタグ生成
            const option = document.createElement('option');
            // 値代入
            option.value = String(obj.id);
            option.textContent  = `${obj.id}: ${obj.channelname}`;
            // セレクトに追加
            channelDom.appendChild(option);
          });

        } catch(e) {
          // エラー処理
          console.log(e);
        }
      });

      // プラン
      window.api.on("planMasterllist", arg => {
        try {
          // プラン自動生成
          arg.forEach((obj, idx) => {
            // オプションタグ生成
            const option = document.createElement('option');
            // 値代入
            option.value = String(obj.id);
            option.textContent  = `${obj.id}: ${obj.planname}`;
            // セレクトに追加
            plannameDom.appendChild(option)
          });

        } catch(e) {
          // エラー処理
          console.log(e);
        }
      });

      // ユーザ
      window.api.on("usersCsvlist", arg => {
        try {
          // ユーザ一覧
          const userArray = arg.record.flat();
          // JSON文字列変換
          const serializedArray = JSON.stringify(userArray);
          // localStorage保存
          localStorage.setItem('userArray', serializedArray);
          // ファイルパス表示
          csvfileDom.innerHTML = arg.filename;
          
        } catch(e) {
          // エラー処理
          console.log(e);
        }
      });

      // ページ遷移
      const transfer = channel => {
        try {
          // 配信ページ遷移
          window.api.send("page", channel);

        } catch(e) {
          // エラー処理
          console.log(e);
        }
      }
      
      // CSVモード
      const readCSV = () => {
        try {
          // CSVモード
          window.api.send("csv");

        } catch(e) {
          // エラー処理
          window.api.send("error", e);
        }
      }

      // 予約配信モード
      const reserve = () => {
        try {
          // ユーザ一覧
          const serializedArray = localStorage.getItem('userArray');
          // エラーフラグ
          let errorflg;
          // エラーメッセージ
          let errorArray = [];
          // エラーメッセージ
          let userArray = [];
          // 選択チャンネル
          const channel = channelDom.value;
          // 選択プラン
          const plan = plannameDom.value;
          // 配信日
          const date = datelDom.value;
          // 配信時間
          const time = timelDom.value + ':00';

          // ユーザなし
          if (!serializedArray) {
            errorArray.push("顧客CSVを選択してください");
            errorflg = true;

          } else {
            // JSON文字列変換
            userArray = JSON.parse(serializedArray);
          }

          // 予約オプション
          const reserveOption = {
            channel: channel, // 選択チャンネル
            plan: plan, // 選択プラン
            date: date, // 配信日
            time: time, // 配信時間
            users: userArray, // ユーザ一覧
            now: false,
          }
          // 予約配信モード
          window.api.send("reserve", reserveOption);

        } catch(e) {
          // エラー処理
          window.api.send("error", e);
        }
      }
    </script>
  </body>
</html>
